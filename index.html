<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Evaluaci√≥n Flash Python ‚Äî One-question UI</title>

    <!-- html2pdf for PDF export (optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Modern skeuomorphism + neutral palette */
        :root {
            --bg1: #e9eef7;
            --card: #f6f9fc;
            --accent: #6f7cff;
            --accent-2: #7c6bff;
            --muted: #59616b;
            --glass: rgba(255, 255, 255, 0.6);
            --soft-shadow: -12px 12px 24px rgba(100, 110, 140, 0.08), 8px -8px 20px rgba(255, 255, 255, 0.6) inset;
            --inset: 0 8px 18px rgba(96, 110, 140, 0.08) inset;
            --round: 14px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(135deg, #e8f0ff 0%, #f6f9fc 100%);
            color: #223;
            padding: 28px;
        }

        .wrap {
            max-width: 960px;
            margin: 0 auto;
            background: linear-gradient(180deg, #fbfdff 0%, #f2f6fb 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 14px 40px rgba(21, 38, 78, 0.08);
            border: 1px solid rgba(120, 130, 160, 0.06);
        }

        header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 20px;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 2px;
        }

        header p {
            color: var(--muted);
            font-size: 13px;
            margin: 0;
        }

        /* mode selector - skeuomorphic cards */
        .modes {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .mode {
            background: var(--card);
            border-radius: 12px;
            padding: 12px 14px;
            width: 220px;
            cursor: pointer;
            box-shadow: var(--soft-shadow);
            border: 1px solid rgba(120, 130, 200, 0.06);
            transition: transform .18s ease, box-shadow .18s ease;
        }

        .mode:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 36px rgba(111, 124, 255, 0.08);
        }

        .mode.active {
            border-color: rgba(110, 120, 255, 0.35);
            box-shadow: 0 20px 48px rgba(110, 120, 255, 0.09);
        }

        .mode h3 {
            font-size: 14px;
            margin-bottom: 6px;
            color: #123;
        }

        .mode p {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 14px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
        }

        .btn {
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 700;
            letter-spacing: .3px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(20, 30, 60, 0.06);
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            color: white;
        }

        .btn.ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid rgba(120, 130, 160, 0.08);
        }

        /* Question card */
        .question-stage {
            margin-top: 18px;
            min-height: 220px;
            position: relative;
        }

        .section-title {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(120, 130, 255, 0.12), rgba(120, 130, 255, 0.06));
            color: var(--accent-2);
            font-weight: 700;
            box-shadow: var(--inset);
            margin-bottom: 12px;
        }

        .qcard {
            margin-top: 12px;
            background: linear-gradient(180deg, #ffffff, #f7fbff);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 12px 18px 30px rgba(60, 80, 120, 0.06), -8px -8px 20px rgba(255, 255, 255, 0.8) inset;
            border: 1px solid rgba(120, 130, 160, 0.04);
        }

        .qtext {
            font-size: 16px;
            margin-bottom: 12px;
            color: #102030;
            min-height: 44px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice {
            background: #fbfdff;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(100, 110, 140, 0.06);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: box-shadow .15s ease, transform .12s ease;
        }

        .choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(30, 50, 90, 0.04);
        }

        .choice input {
            transform: scale(1.05);
        }

        .input-text {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(120, 130, 160, 0.08);
            font-family: monospace;
        }

        /* progress and timer */
        .progress-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .progress {
            flex: 1;
            height: 10px;
            background: linear-gradient(90deg, #ecf0ff, #f3f6ff);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(120, 130, 160, 0.03);
            margin-right: 12px;
        }

        .progress>i {
            display: block;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            border-radius: 10px;
            transition: width .35s ease;
        }

        .timer {
            min-width: 130px;
            text-align: right;
            font-weight: 800;
            color: var(--accent-2);
        }

        .timer.small {
            font-size: 14px;
        }

        .timer.warn {
            color: #f57c00;
        }

        .timer.danger {
            color: #d32f2f;
        }

        /* footer controls (prev/next/evaluate) */
        .nav {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .nav-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn.secondary {
            background: linear-gradient(180deg, #fff, #f4f7ff);
            color: var(--muted);
            border: 1px solid rgba(120, 130, 160, 0.06);
            box-shadow: 0 8px 20px rgba(20, 30, 60, 0.04);
        }

        /* Report styles */
        .report {
            margin-top: 20px;
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(180deg, #ffffff, #f7fbff);
            box-shadow: 12px 18px 30px rgba(60, 80, 120, 0.04);
            border: 1px solid rgba(120, 130, 160, 0.04);
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
        }

        .badge.excellent {
            background: #e8fff0;
            color: #0b7a4e;
            border: 1px solid rgba(11, 122, 78, 0.08);
        }

        .badge.good {
            background: #f0f3ff;
            color: var(--accent-2);
            border: 1px solid rgba(110, 120, 255, 0.08);
        }

        .badge.needs {
            background: #fff4e6;
            color: #b24f00;
            border: 1px solid rgba(178, 79, 0, 0.08);
        }

        .wrong-list {
            margin-top: 8px;
            color: #333;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        @media (max-width:720px) {
            .modes {
                justify-content: center;
            }

            .mode {
                width: 100%;
                max-width: 360px;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">

        <header>
            <div>
                <h1>üêç Evaluaci√≥n Flash Python</h1>
                <p>Preguntas b√°sicas ‚Äî modo ‚Äúun pregunta a la vez‚Äù</p>
            </div>
            <div style="margin-left:auto; text-align:right;">
                <div class="small">Archivo base: <strong>pflash-index_v1.html</strong></div>
                <div class="small">(Adaptado)</div>
            </div>
        </header>

        <!-- Mode selector: No timer / 5s / 10s per question -->
        <div>
            <div class="small" style="margin-bottom:8px;">Modo por pregunta ‚Äî el cron√≥metro se reinicia en cada pregunta
            </div>
            <div class="modes" id="modeOptions">
                <div class="mode active" data-mode="none" onclick="setMode(this)">
                    <h3>Sin cron√≥metro</h3>
                    <p>Responde libremente. Ning√∫n l√≠mite por pregunta.</p>
                </div>
                <div class="mode" data-mode="5" onclick="setMode(this)">
                    <h3>‚è± 5 segundos</h3>
                    <p>Modo r√°pido ‚Äî 5s para cada pregunta.</p>
                </div>
                <div class="mode" data-mode="10" onclick="setMode(this)">
                    <h3>‚è± 10 segundos</h3>
                    <p>Modo intermedio ‚Äî 10s por pregunta.</p>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px;">
                <div class="small">Las preguntas se han barajado y se muestra solo el texto (n√∫mero guardado
                    internamente).</div>
                <div class="controls">
                    <button class="btn secondary" id="startBtn" onclick="startQuiz()">üöÄ Comenzar</button>
                </div>
            </div>
        </div>

        <!-- Question stage -->
        <div class="question-stage" id="stage" style="display:none;">
            <div class="section-title" id="currentSection">Secci√≥n</div>

            <div class="qcard">
                <div
                    style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:220px;">
                        <div class="qtext" id="qText">Pregunta</div>

                        <div id="answerArea"></div>
                    </div>

                    <div style="width:220px; min-width:160px;">
                        <div style="margin-bottom:8px;" class="small">Progreso</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="progress"><i id="progressBar"></i></div>
                            <div style="text-align:right;">
                                <div id="progressCount" class="small">0 / 0</div>
                            </div>
                        </div>

                        <div style="margin-top:12px;">
                            <div class="small">Cron√≥metro por pregunta</div>
                            <div id="perTimer" class="timer small">‚Äî</div>
                        </div>

                        <div style="margin-top:16px;">
                            <div class="small">Sin responder = 0 puntos</div>
                        </div>
                    </div>
                </div>

                <div class="nav" style="margin-top:16px;">
                    <div class="nav-left">
                        <button class="btn ghost" id="prevBtn" onclick="prevQ()" disabled>‚¨ÖÔ∏é Anterior</button>
                        <button class="btn ghost" id="nextBtn" onclick="nextQ()">Siguiente ‚ûú</button>
                    </div>

                    <div class="nav-right">
                        <button class="btn secondary" onclick="shuffleQuestions(true)">üîÄ Rebarajar</button>
                        <button class="btn" id="evaluateBtn" onclick="evaluateQuiz()">Evaluar</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Report area -->
        <div id="reportArea" style="display:none; margin-top:18px;">
            <div class="report" id="reportCard">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                    <h3 id="reportTitle">Informe ‚Äî Resultado</h3>
                    <div id="reportScore" class="badge">0%</div>
                </div>

                <div style="margin-top:12px;">
                    <div id="reportMessage" class="small"></div>
                </div>

                <div id="wrongAnswers" style="margin-top:12px;"></div>

                <div style="display:flex; gap:8px; margin-top:14px; flex-wrap:wrap;">
                    <button class="btn" onclick="downloadPDFReport()">üì• Descargar PDF</button>
                    <button class="btn secondary" onclick="location.reload()">üîÅ Nueva Evaluaci√≥n</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        /*
          Implementation notes:
          - This script reads question groups from an embedded QUESTIONS object (derived from original form).
          - Keeps internal ids and section titles.
          - Shuffles questions at start or when requested.
          - Shows one question at a time and enforces per-question timer (none / 5 / 10).
          - On "Evaluar" it calculates score, shows color-coded result and a list of wrong answers.
        */

        /* ---------- QUESTIONS DEFINITION ----------
           For portability we reconstruct the questions from the original page content.
           I used the same IDs and content you provided in the original file (pflash-index_v1.html).
           Each question object shape:
             {
               id: 'p1_1', section: 'Sintaxis de Objetos', type: 'mc'|'fill'|'tf'|'identify',
               text: 'Pregunta visible text',
               choices: [ {text, value} ]    // only for mc
               correct: ...                 // pattern to score (see below)
             }
           The correct answers follow the logic: MC -> an array of booleans, TF -> 'verdadero'|'falso',
           fill/identify -> array of acceptable lowercase strings / substrings.
        */
        const QUESTIONS = (function () {
            // Reconstructed from original file definitions; numbering kept in id.
            // For brevity some acceptable alternatives are included.
            return [
                // Section 1
                {
                    id: 'p1_1', section: 'Sintaxis de Objetos', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øCu√°les son formas v√°lidas para definir una cadena en Python?",
                    choices: [
                        { text: "'texto entre comillas simples'", value: '1' },
                        { text: '"texto entre comillas dobles"', value: '1' },
                        { text: '`texto entre backticks`', value: '0' },
                        { text: '"""texto entre triple comillas"""', value: '1' }
                    ],
                    correct: [true, true, false, true]
                },
                {
                    id: 'p1_2', section: 'Sintaxis de Objetos', type: 'fill',
                    text: "(Rellenar) ¬øCon qu√© caracteres se define una tupla en Python? Escribe los dos caracteres:",
                    correct: ['( )', '()', '(', ')', '(,)', '( , )']
                },
                {
                    id: 'p1_3', section: 'Sintaxis de Objetos', type: 'tf',
                    text: '(Verdadero/Falso) Las comillas triples ("""texto""") se usan para cadenas multil√≠nea en Python.',
                    correct: 'verdadero'
                },
                {
                    id: 'p1_4', section: 'Sintaxis de Objetos', type: 'fill',
                    text: '(Identificar) Identifica el tipo de objeto en: {"clave": 1, "otro": 2}',
                    correct: ['diccionario', 'dict', 'dictionary']
                },

                // Section 2
                {
                    id: 'p2_1', section: 'Segmentaci√≥n', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øCu√°les objetos Python permiten segmentaci√≥n por √≠ndice?",
                    choices: [
                        { text: 'lista', value: '1' },
                        { text: 'tupla', value: '1' },
                        { text: 'conjunto (set)', value: '0' },
                        { text: 'cadena (string)', value: '1' }
                    ],
                    correct: [true, true, false, true]
                },
                {
                    id: 'p2_2', section: 'Segmentaci√≥n', type: 'fill',
                    text: "(Rellenar) Escribe la expresi√≥n para acceder a los √∫ltimos 3 elementos de una lista llamada 'datos':",
                    correct: ['datos[-3:]', 'datos[-3:len(datos)]']
                },
                {
                    id: 'p2_3', section: 'Segmentaci√≥n', type: 'tf',
                    text: "(Verdadero/Falso) Puedo usar segmentaci√≥n (slicing) en un conjunto (set).",
                    correct: 'falso'
                },
                {
                    id: 'p2_4', section: 'Segmentaci√≥n', type: 'fill',
                    text: '(Identificar) ¬øCu√°l es el resultado de x = "python"[1:4]?',
                    correct: ['yth']
                },

                // Section 3
                {
                    id: 'p3_1', section: 'Series vs DataFrame', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øQu√© caracter√≠sticas ofrece solo DataFrame, no Series?",
                    choices: [
                        { text: 'Almacenamiento de m√∫ltiples columnas', value: '1' },
                        { text: 'Indexaci√≥n de filas y columnas', value: '1' },
                        { text: 'Habilidad de seleccionar columnas', value: '1' },
                        { text: 'Matem√°ticas elemento a elemento', value: '0' }
                    ],
                    correct: [true, true, true, false]
                },
                {
                    id: 'p3_2', section: 'Series vs DataFrame', type: 'fill',
                    text: '(Rellenar) ¬øCu√°l es la librer√≠a de Python para Series y DataFrame?',
                    correct: ['pandas', 'pd']
                },
                {
                    id: 'p3_3', section: 'Series vs DataFrame', type: 'tf',
                    text: '(Verdadero/Falso) Una Series de pandas solo puede almacenar una √∫nica columna de datos.',
                    correct: 'verdadero'
                },
                {
                    id: 'p3_4', section: 'Series vs DataFrame', type: 'fill',
                    text: "(Identificar) ¬øQu√© tipo de objeto se crea con pd.Series([10, 20, 30])?",
                    correct: ['series', 'Series']
                },

                // Section 4
                {
                    id: 'p4_1', section: 'DataFrame vs Matriz', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øQu√© hace a un DataFrame distinto de una matriz NumPy?",
                    choices: [
                        { text: 'Etiquetas para columnas', value: '1' },
                        { text: 'Permite tipos de datos heterog√©neos', value: '1' },
                        { text: 'Broadcasting aritm√©tico', value: '0' },
                        { text: '√çndices personalizados para filas', value: '1' }
                    ],
                    correct: [true, true, false, true]
                },
                {
                    id: 'p4_2', section: 'DataFrame vs Matriz', type: 'fill',
                    text: '(Rellenar) ¬øCu√°l es el paquete est√°ndar de Python para objetos matriz?',
                    correct: ['numpy', 'np']
                },
                {
                    id: 'p4_3', section: 'DataFrame vs Matriz', type: 'tf',
                    text: '(Verdadero/Falso) Un DataFrame de pandas puede almacenar columnas con tipos de datos mixtos, mientras que una matriz no.',
                    correct: 'verdadero'
                },
                {
                    id: 'p4_4', section: 'DataFrame vs Matriz', type: 'fill',
                    text: '(Identificar) ¬øQu√© tipo de objeto se crea con np.array([[1,2],[3,4]])?',
                    correct: ['ndarray', 'array', 'matriz']
                },

                // Section 5
                {
                    id: 'p5_1', section: 'Tupla, Diccionario y Conjunto', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øCu√°les tipos de objetos Python son mutables?",
                    choices: [
                        { text: 'Tupla', value: '0' },
                        { text: 'Diccionario', value: '1' },
                        { text: 'Conjunto (set)', value: '1' },
                        { text: 'Lista', value: '1' }
                    ],
                    correct: [false, true, true, true]
                },
                {
                    id: 'p5_2', section: 'Tupla, Diccionario y Conjunto', type: 'fill',
                    text: '(Rellenar) Escribe un ejemplo de conjunto Python con tres elementos:',
                    correct: null  // any non-empty valid-looking set will be accepted (we check presence)
                },
                {
                    id: 'p5_3', section: 'Tupla, Diccionario y Conjunto', type: 'tf',
                    text: '(Verdadero/Falso) Los diccionarios no pueden contener claves duplicadas.',
                    correct: 'verdadero'
                },
                {
                    id: 'p5_4', section: 'Tupla, Diccionario y Conjunto', type: 'fill',
                    text: '(Identificar) Identifica los tipos: x = (5, 6), y = {"a": 1}, z = {8, 9}',
                    correct: ['tupla, diccionario, conjunto', 'tuple, dict, set', 'tupla,diccionario,conjunto']
                },

                // Section 6
                {
                    id: 'p6_1', section: 'Lista vs Conjunto', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øQu√© caracter√≠sticas distinguen un conjunto de una lista?",
                    choices: [
                        { text: 'Los elementos son √∫nicos', value: '1' },
                        { text: 'Los elementos pueden indexarse', value: '0' },
                        { text: 'El orden est√° garantizado', value: '0' },
                        { text: 'Soporta operaciones de conjunto (uni√≥n, intersecci√≥n)', value: '1' }
                    ],
                    correct: [true, false, false, true]
                },
                {
                    id: 'p6_2', section: 'Lista vs Conjunto', type: 'fill',
                    text: '(Rellenar) Escribe una lista Python con valores 1, 2 y 2:',
                    correct: ['[1, 2, 2]', '[1,2,2]', '[ 1, 2, 2 ]']
                },
                {
                    id: 'p6_3', section: 'Lista vs Conjunto', type: 'tf',
                    text: '(Verdadero/Falso) Las listas pueden contener elementos duplicados.',
                    correct: 'verdadero'
                },
                {
                    id: 'p6_4', section: 'Lista vs Conjunto', type: 'fill',
                    text: '(Identificar) Identifica qu√© es cada uno: [2, 3, 4] y {2, 3, 4}',
                    correct: ['lista, conjunto', 'list, set']
                },

                // Section 7
                {
                    id: 'p7_1', section: 'Indentaci√≥n y Flujo', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øCu√°les son niveles de indentaci√≥n v√°lidos en Python?",
                    choices: [
                        { text: '2 espacios', value: '1' },
                        { text: '4 espacios', value: '1' },
                        { text: '1 tabulaci√≥n', value: '1' },
                        { text: '3 espacios', value: '0' }
                    ],
                    correct: [true, true, true, false]
                },
                {
                    id: 'p7_2', section: 'Indentaci√≥n y Flujo', type: 'fill',
                    text: '(Rellenar) ¬øQu√© s√≠mbolo es obligatorio al final de una l√≠nea if en Python?',
                    correct: [':']
                },
                {
                    id: 'p7_3', section: 'Indentaci√≥n y Flujo', type: 'tf',
                    text: '(Verdadero/Falso) Python requiere indentaci√≥n consistente para definir bloques de c√≥digo.',
                    correct: 'verdadero'
                },
                {
                    id: 'p7_4', section: 'Indentaci√≥n y Flujo', type: 'fill',
                    text: '(Identificar) Identifica el error en este c√≥digo: for i in range(5)\\nprint(i)',
                    correct: ['falta dos puntos', 'falta :', 'missing :']
                },

                // Section 8
                {
                    id: 'p8_1', section: 'Definici√≥n de Bucles', type: 'mc',
                    text: "(Opci√≥n M√∫ltiple) ¬øCu√°l es la estructura correcta de un bucle for en Python?",
                    choices: [
                        { text: 'for variable in secuencia:', value: '1' },
                        { text: 'for variable in secuencia', value: '0' },
                        { text: 'for (variable in secuencia):', value: '0' },
                        { text: 'Luego hay indentaci√≥n para el cuerpo del bucle', value: '1' }
                    ],
                    correct: [true, false, false, true]
                },
                {
                    id: 'p8_2', section: 'Definici√≥n de Bucles', type: 'fill',
                    text: "(Rellenar) Completa la estructura: if condition: ... _____ print('no')",
                    correct: ['else:', 'else']
                },
                {
                    id: 'p8_3', section: 'Definici√≥n de Bucles', type: 'tf',
                    text: '(Verdadero/Falso) La cl√°usula else puede usarse sin elif en una estructura if-elif-else.',
                    correct: 'verdadero'
                },
                {
                    id: 'p8_4', section: 'Definici√≥n de Bucles', type: 'fill',
                    text: "(Identificar) ¬øCu√°l es el error principal? if x > 5\\n    print('mayor')",
                    correct: ['falta :', 'missing :']
                }

            ];
        })();

        /* ---------- State ---------- */
        let modePerQuestion = 'none'; // 'none' | '5' | '10'
        let questions = []; // will be shuffled copy
        let currentIndex = 0;
        let perTimerInterval = null;
        let perTimeLeft = 0;
        let answers = {}; // store user answers keyed by question id

        /* ---------- UI helpers ---------- */
        function setMode(el) {
            document.querySelectorAll('.mode').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            modePerQuestion = el.dataset.mode;
        }

        function startQuiz() {
            // make a shallow copy and shuffle
            questions = QUESTIONS.map(q => Object.assign({}, q));
            shuffleQuestions(false);
            currentIndex = 0;
            answers = {};
            document.getElementById('stage').style.display = 'block';
            document.getElementById('reportArea').style.display = 'none';
            renderCurrent();
        }

        function shuffleQuestions(preservePosition) {
            // shuffle in-place using Fisher-Yates
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            // reset index if asked
            if (!preservePosition) currentIndex = 0;
            renderCurrent();
        }

        /* ---------- Render question ---------- */
        function renderCurrent() {
            clearPerTimer();
            const q = questions[currentIndex];
            if (!q) return;

            // section title, question text
            document.getElementById('currentSection').textContent = q.section;
            // show question text without numbering (id kept internally)
            document.getElementById('qText').textContent = q.text;

            // build answer area depending on type
            const area = document.getElementById('answerArea');
            area.innerHTML = '';

            if (q.type === 'mc') {
                const container = document.createElement('div');
                container.className = 'choices';
                q.choices.forEach((c, idx) => {
                    const wrapper = document.createElement('label');
                    wrapper.className = 'choice';
                    wrapper.innerHTML = `
        <input type="checkbox" data-q="${q.id}" data-idx="${idx}">
        <div style="flex:1;">${c.text}</div>
      `;
                    // restore checked from answers if exists
                    const cb = wrapper.querySelector('input');
                    const saved = answers[q.id];
                    if (saved && Array.isArray(saved) && saved.includes(idx)) cb.checked = true;
                    cb.addEventListener('change', () => {
                        const checked = Array.from(container.querySelectorAll('input:checked')).map(i => +i.dataset.idx);
                        answers[q.id] = checked;
                    });
                    container.appendChild(wrapper);
                });
                area.appendChild(container);
            } else if (q.type === 'tf') {
                const container = document.createElement('div');
                container.className = 'choices';
                ['verdadero', 'falso'].forEach(opt => {
                    const wrapper = document.createElement('label');
                    wrapper.className = 'choice';
                    wrapper.innerHTML = `<input type="radio" name="${q.id}" data-q="${q.id}" value="${opt}"> <div style="flex:1;">${opt[0].toUpperCase() + opt.slice(1)}</div>`;
                    const rb = wrapper.querySelector('input');
                    if (answers[q.id] && answers[q.id] === opt) rb.checked = true;
                    rb.addEventListener('change', () => answers[q.id] = rb.value);
                    container.appendChild(wrapper);
                });
                area.appendChild(container);
            } else if (q.type === 'fill' || q.type === 'identify') {
                const input = document.createElement('input');
                input.className = 'input-text';
                input.type = 'text';
                input.placeholder = 'Tu respuesta...';
                input.value = answers[q.id] || '';
                input.addEventListener('input', () => answers[q.id] = input.value.trim());
                area.appendChild(input);
            }

            // progress
            const doneCount = Object.keys(answers).length;
            document.getElementById('progressCount').textContent = `${currentIndex + 1} / ${questions.length}`;
            const pct = Math.round(((currentIndex) / Math.max(1, questions.length - 1)) * 100);
            document.getElementById('progressBar').style.width = `${Math.round(((currentIndex) / questions.length) * 100)}%`;

            // prev/next buttons
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === questions.length - 1;

            // start per-question timer
            startPerTimer();
        }

        /* ---------- Navigation ---------- */
        function nextQ() {
            saveCurrentInput(); // just to be safe
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                renderCurrent();
            }
        }
        function prevQ() {
            saveCurrentInput();
            if (currentIndex > 0) {
                currentIndex--;
                renderCurrent();
            }
        }

        function saveCurrentInput() {
            // data already saved on change, but try to fetch inputs if user typed and didn't trigger change
            const q = questions[currentIndex];
            if (!q) return;
            if (q.type === 'fill' || q.type === 'identify') {
                const txt = document.querySelector('#answerArea input');
                if (txt) answers[q.id] = txt.value.trim();
            } else if (q.type === 'mc') {
                const checked = Array.from(document.querySelectorAll('#answerArea input[type="checkbox"]:checked')).map(i => +i.dataset.idx);
                answers[q.id] = checked;
            } else if (q.type === 'tf') {
                const rb = document.querySelector('#answerArea input[type="radio"]:checked');
                if (rb) answers[q.id] = rb.value;
            }
        }

        /* ---------- Per-question timer ---------- */
        function startPerTimer() {
            clearPerTimer();
            const el = document.getElementById('perTimer');
            if (modePerQuestion === 'none') {
                el.textContent = '‚Äî';
                el.className = 'timer small';
                return;
            }
            perTimeLeft = parseInt(modePerQuestion, 10);
            updatePerTimerUI();
            perTimerInterval = setInterval(() => {
                perTimeLeft--;
                updatePerTimerUI();
                if (perTimeLeft <= 0) {
                    clearPerTimer();
                    // auto-progress: unanswered stays as undefined (counts 0). Move to next question or show end.
                    // For UX, we mark as unanswered (no change) and move on.
                    if (currentIndex < questions.length - 1) {
                        currentIndex++;
                        renderCurrent();
                    } else {
                        // last question ‚Äî optionally evaluate automatically
                        evaluateQuiz();
                    }
                }
            }, 1000);
        }

        function updatePerTimerUI() {
            const el = document.getElementById('perTimer');
            el.textContent = `‚è± ${perTimeLeft}s`;
            el.className = 'timer small';
            if (perTimeLeft <= 3) el.classList.add('danger');
            else if (perTimeLeft <= 6) el.classList.add('warn');
        }

        function clearPerTimer() {
            if (perTimerInterval) { clearInterval(perTimerInterval); perTimerInterval = null; }
        }

        /* ---------- Scoring ---------- */
        function evaluateQuiz() {
            // ensure current input saved
            saveCurrentInput();
            clearPerTimer();

            let total = questions.length;
            let score = 0;
            const wrong = [];

            questions.forEach(q => {
                const user = answers[q.id];
                let ok = false;

                if (q.type === 'mc') {
                    // If user didn't check anything => unanswered => 0
                    if (!Array.isArray(user) || user.length === 0) { ok = false; }
                    else {
                        // compare selected indices to correct mask
                        const correctMask = q.correct.map((v, i) => v ? i : null).filter(i => i !== null);
                        // user must select exactly those indices (order doesn't matter)
                        const uSorted = Array.from(new Set(user)).sort((a, b) => a - b);
                        const cSorted = Array.from(new Set(correctMask)).sort((a, b) => a - b);
                        ok = (uSorted.length === cSorted.length) && uSorted.every((v, i) => v === cSorted[i]);
                    }
                } else if (q.type === 'tf') {
                    ok = !!user && user.toLowerCase() === q.correct.toLowerCase();
                } else if (q.type === 'fill' || q.type === 'identify') {
                    if (!user || user.trim() === '') { ok = false; }
                    else {
                        const u = user.toLowerCase();
                        if (q.correct === null) {
                            // open accept: non-empty => accept (but that might be too lenient).
                            // We'll accept any non-empty for those questions (original form allowed free answers).
                            ok = u.length > 0;
                        } else {
                            ok = q.correct.some(candidate => u.includes(candidate.toLowerCase()) || candidate.toLowerCase().includes(u));
                        }
                    }
                }

                if (ok) score++;
                else {
                    // record wrong with short explanation and the question ID for display
                    wrong.push({
                        id: q.id,
                        section: q.section,
                        text: q.text,
                        your: (user === undefined || user === null || (Array.isArray(user) && user.length === 0)) ? '(sin responder)' : (Array.isArray(user) ? user.map(i => (q.choices && q.choices[i] ? q.choices[i].text : i)).join(', ') : user),
                        expected: expectedReadable(q)
                    });
                }
            });

            // show report
            showReport(score, total, wrong);
        }

        function expectedReadable(q) {
            if (q.type === 'mc') {
                const good = q.correct.map((v, i) => v ? q.choices[i].text : null).filter(Boolean);
                return good.join(' ‚Äî ');
            } else if (q.type === 'tf') {
                return q.correct;
            } else if (Array.isArray(q.correct)) {
                return q.correct.join(' / ');
            } else return '(respuesta esperada)';
        }

        /* ---------- Report UI ---------- */
        function showReport(score, total, wrong) {
            const pct = Math.round((score / total) * 100);
            const reportArea = document.getElementById('reportArea');
            reportArea.style.display = 'block';
            document.getElementById('reportScore').textContent = `${pct}%`;
            const badge = document.getElementById('reportScore');

            // color-coded
            badge.className = 'badge';
            if (pct >= 90) { badge.classList.add('excellent'); document.getElementById('reportMessage').textContent = '¬°Eres una estrella! Has dominado la mayor√≠a de los conceptos.'; }
            else if (pct >= 70) { badge.classList.add('good'); document.getElementById('reportMessage').textContent = '¬°Buen trabajo! Repasa unas cuantas preguntas.'; }
            else { badge.classList.add('needs'); document.getElementById('reportMessage').textContent = 'Sigue practicando ‚Äî revisa las preguntas incorrectas.'; }

            // wrong answers list
            const wa = document.getElementById('wrongAnswers');
            wa.innerHTML = '';
            if (wrong.length === 0) {
                wa.innerHTML = '<div style="margin-top:8px;color:#0b7a4e;font-weight:700;">Todas las respuestas correctas ‚úÖ</div>';
            } else {
                const h = document.createElement('div');
                h.innerHTML = `<div style="margin-top:8px; font-weight:700;">Preguntas incorrectas (${wrong.length}):</div>`;
                wa.appendChild(h);
                const list = document.createElement('div');
                list.className = 'wrong-list';
                wrong.forEach(item => {
                    const row = document.createElement('div');
                    row.style.padding = '10px';
                    row.style.marginTop = '8px';
                    row.style.borderRadius = '10px';
                    row.style.background = 'linear-gradient(180deg,#fff,#fbfdff)';
                    row.style.border = '1px solid rgba(120,130,160,0.04)';
                    row.innerHTML = `<div style="font-weight:700;">${item.section} ‚Äî ${item.text}</div>
        <div style="margin-top:6px;" class="small"><strong>Tu respuesta:</strong> ${escapeHtml(item.your)}</div>
        <div class="small"><strong>Esperado:</strong> ${escapeHtml(item.expected)}</div>`;
                    list.appendChild(row);
                });
                wa.appendChild(list);
            }

            // hide question stage to avoid confusion
            document.getElementById('stage').style.display = 'none';
            // scroll
            document.getElementById('reportCard').scrollIntoView({ behavior: 'smooth' });
        }

        /* ---------- Utilities ---------- */
        function escapeHtml(s) {
            return String(s).replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
        }

        function downloadPDFReport() {
            const el = document.getElementById('reportCard');
            const opt = {
                margin: 10,
                filename: `Evaluacion_Python_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(el).save();
        }

        /* ---------- initialization: show brief info ---------- */
        (function init() {
            // default mode is none
            modePerQuestion = 'none';
        })();
    </script>

</body>

</html>